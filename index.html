let keyData = null;
let timerInterval = null;

async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    let keyId = urlParams.get('id');

    if (keyId) {
        await loadExistingKey(keyId);
    } else {
        await generateNewKey();
    }
}

async function loadExistingKey(keyId) {
    try {
        console.log('Loading existing key:', keyId);
        const response = await fetch(`/api/key?id=${keyId}`);
        const data = await response.json();
        
        console.log('Key data received:', data);

        if (!data.valid) {
            console.log('Key is not valid');
            showExpired();
            return;
        }

        keyData = {
            key: data.key,
            expiresAt: data.expiresAt // Already in milliseconds
        };
        
        console.log('Key data processed:', keyData);
        displayKey();
        startTimer();
    } catch (error) {
        console.error('Error loading key:', error);
        showExpired();
    }
}

async function generateNewKey() {
    try {
        console.log('Generating new key...');
        const response = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ duration: 48 })
        });

        const data = await response.json();
        console.log('Generate response:', data);

        if (!data.success) {
            console.error('Generation failed:', data);
            showExpired();
            return;
        }

        const newUrl = `${window.location.origin}?id=${data.id}`;
        window.history.replaceState({}, '', newUrl);

        // Convert ISO string to milliseconds
        const expiresAt = new Date(data.expiresAt).getTime();
        
        keyData = {
            key: data.key,
            expiresAt: expiresAt
        };

        console.log('Key data set:', keyData);
        console.log('Current time:', Date.now());
        console.log('Expires at:', expiresAt);
        console.log('Time difference (hours):', (expiresAt - Date.now()) / (1000 * 60 * 60));

        displayKey();
        startTimer();
    } catch (error) {
        console.error('Error generating key:', error);
        showExpired();
    }
}

function displayKey() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('keySection').style.display = 'block';
    document.getElementById('keyDisplay').textContent = keyData.key;
}

function startTimer() {
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    const now = Date.now();
    const expiresAt = keyData.expiresAt;
    const timeLeft = expiresAt - now;

    console.log('Timer update:', { now, expiresAt, timeLeft });

    if (timeLeft <= 0) {
        console.log('Timer expired');
        clearInterval(timerInterval);
        showExpired();
        return;
    }

    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

    const timeString = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    const timerEl = document.getElementById('timer');
    timerEl.textContent = timeString;

    if (hours < 6) {
        timerEl.classList.add('warning');
    }
    if (hours < 1) {
        timerEl.classList.add('expired');
    }
}

function pad(num) {
    return num.toString().padStart(2, '0');
}

function showExpired() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('keySection').style.display = 'none';
    document.getElementById('expiredSection').style.display = 'block';
}

function copyKey() {
    navigator.clipboard.writeText(keyData.key).then(() => {
        const btn = document.querySelector('.copy-btn');
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = '#4CAF50';
        btn.style.color = '#ffffff';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '#ffffff';
            btn.style.color = '#000000';
        }, 2000);
    });
}

init();
